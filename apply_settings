# Set time zone
echo Setting time zone and language
ln -sf /usr/share/zoneinfo/Asia/Seoul /etc/localtime
sed -i '/^#\(ko_KR.UTF-8 UTF-8\|en_US.UTF-8 UTF-8\) /s/^#//g' /etc/locale.gen
echo LANG=en_US.UTF-8 > /etc/locale.conf

# Create new user and set privileges
echo Creating new user
do_proceed="n"
while [ "${do_proceed}" == "n" ] || [ "${do_proceed}" == "N" ]; do
	read -p "Please type your username: " username
	if [ "${username}" == "" ]; then
		echo Username can\'t be an empty string.
	else
		echo Username will be ${username}
		echo Hostname will be ${username}-pc
		read -p "Are these correct?(y/n)" do_proceed
	fi
done

echo "${username}-pc" >> /etc/hostname
echo "127.0.0.1 localhost\n::1 localhost\n127.0.1.1 ${username}-pc.org" >> /etc/hosts

useradd ${username} -g users -G storage,wheel,power -m -s /bin/bash
read -s -p "Enter new password for ${username}: (input is not visible)" userpw
echo ${username}:${userpw} | chpasswd
echo
read -s -p "Enter new password for root: (leave empty if you want to use user's pw)" rootpw
if [ "${rootpw}" != "" ]; then
	echo "root:${rootpw}" | chpasswd
else
	echo "root:${userpw}" | chpasswd
fi

# Create symlink
if [[ "${partition_hdd}" != "" ]]; then
	echo
	echo Creating symlinks for the following directories:
	rm ~/Downloads
	rm ~/Documents
	rm ~/Videos
	rm ~/Pictures
	rm ~/Music
	echo ~/Downloads
	echo ~/Documents
	echo ~/Videos
	echo ~/Pictures
	echo ~/Music
	ln -s /hdd/Pictures ~/Pictures
	ln -s /hdd/Videos ~/Videos
	ln -s /hdd/Downloads ~/Downloads
	ln -s /hdd/Music ~/Music
	ln -s /hdd/Documents ~/Documents
fi

# Install packages
echo Installing packages...
pacman -Syyu
pacman -S base-devel
yes | pacman -S sudo git vim wget yajl > dev/null

echo "echo Installing pamac-AUR for GUI package managing
cd /tmp
git clone https://aur.archlinux.org/package-query.git
cd package-query/
makepkg -si && cd /tmp/
git clone https://aur.archlinux.org/yaourt.git
cd yaourt/
makepkg -si
yaourt -S pamac-aur
cd ~" > /home/${username}/Desktop/install_aur

# Install bootloader
containsElement () {
  local e match="$1"
  shift
  for e; do [[ "$e" == "$match" ]] && return 1; done
  return 0
}

fdisk -l
fdisk_output=( $(fdisk -l) )
for (( i=$(( ${#fdisk_output[@]} - 1 )); i>=0; i--)); do
	if [[ ${fdisk_output[$i]} =~ "/dev/" ]]; then
		:
	else
		unset fdisk_output[$i]
	fi
done

check_flag=0
while [ "${check_flag}" == 0 ]; do
	install_grub=1
	check_flag=1
	read -p "Enter boot partition(Leave empty if don't want to install bootloader): " partition_boot
	containsElement "${partition_boot}" "${fdisk_output[@]}"
	res=$?
	if [ "${res}" != 1 ] || [ "${partition_boot}" == "" ]; then
		install_grub=0
	fi

	if [ "${install_grub}" == 0 ] && [ "${partition_boot}" != "" ]; then
		echo -e "${GREEN}Boot${NC} device name is incorrect (or does not exist)"
		check_flag=0
	fi
done

fdisk_output=( $(fdisk -l) )
containsElement "Microsoft" ${fdisk_output[@]}
res=?
if [ "${res}" == 1 ]; then
	echo "has windows"
else
	echo "doesn\'t have windows"
fi

read -p "This system will install Gnome desktop environment(GDM) by default. Continue?(y/n)" install_gdm
if [ "${install_gdm}" != "n" ] && [ "${install_gdm}" != "N" ]; then
	pacman -S xorg xorg-server
	pacman -S gnome
	systemctl enable gdm.service
else
	echo "You may install any other desktop environment"
fi

read -p "Do you want to install fcitx for Korean?(y/n)" install_fcitx
if [ "${install_fcitx}" != "n" ] && [ "${install_fcitx}" != "N" ]; then
	pacman -S fcitx fcitx-hangul fcitx-qt5 fcitx-configtool
fi

read -p "Do you want to install CUDA-toolkit, NVIDIA for development?(y/n)" install_cuda_nvidia
if [ "${install_cuda_nvidia}" != "n" ] && [ "${install_cuda_nvidia}" != "N" ]; then
	pacman -S linux nvidia cuda
fi