# Set time zone
echo Setting time zone and language
ln -sf /usr/share/zoneinfo/Asia/Seoul /etc/localtime
sed -i '/^#\(ko_KR.UTF-8 UTF-8\|en_US.UTF-8 UTF-8\) /s/^#//g' /etc/locale.gen
echo LANG=en_US.UTF-8 > /etc/locale.conf
locale-gen

# Create new user and set privileges
echo Creating new user
do_proceed="n"
while [ "${do_proceed}" == "n" ] || [ "${do_proceed}" == "N" ]; do
	read -p "Please type your username: " username
	if [ "${username}" == "" ]; then
		echo Username can\'t be an empty string.
	else
		echo Username will be ${username}
		echo Hostname will be ${username}-pc
		read -p "Are these correct?(y/n)" do_proceed
	fi
done

echo "${username}-pc" >> /etc/hostname
echo "127.0.0.1 localhost\n::1 localhost\n127.0.1.1 ${username}-pc.org" >> /etc/hosts

groupadd sudo
useradd ${username} -g users -G storage,wheel,power,sudo -m -s /bin/bash
read -s -p "Enter new password for ${username}: (input is not visible)" userpw
echo ${username}:${userpw} | chpasswd
echo
read -s -p "Enter new password for root: (leave empty if you want to use user's pw)" rootpw
if [ "${rootpw}" != "" ]; then
	echo "root:${rootpw}" | chpasswd
else
	echo "root:${userpw}" | chpasswd
fi


rm -rf /home/${username}/Downloads /home/${username}/Documents /home/${username}/Videos /home/${username}/Pictures /home/${username}/Music /home/${username}/Desktop
ln -s /hdd/Desktop /home/${username}/Desktop
ln -s /hdd/Pictures /home/${username}/Pictures
ln -s /hdd/Videos /home/${username}/Videos
ln -s /hdd/Downloads /home/${username}/Downloads
ln -s /hdd/Music /home/${username}/Music
ln -s /hdd/Documents /home/${username}/Documents
chown -R ${username}:users /hdd

# Install packages
echo Installing packages...
pacman -Syyu
pacman -S base-devel
yes | pacman -S git vim wget yajl > dev/null

echo Changing sudo privileges
sed -i 's/^# %sudo ALL=(ALL) ALL/%sudo ALL=(ALL) ALL/' /etc/sudoers

echo "echo Installing pamac-AUR for GUI package managing
cd /tmp
git clone https://aur.archlinux.org/package-query.git
cd package-query/
makepkg -si && cd /tmp/
git clone https://aur.archlinux.org/yaourt.git
cd yaourt/
makepkg -si
yaourt -S pamac-aur
cd ~" > /hdd/Desktop/install_aur
chmod +x /hdd/Desktop/install_aur

pacman -S os-prober
mkdir /windows
mount ${partition_windows} /windows
os-prober
yes | pacman -S intel-ucode

mkfs.fat -F32 "${partition_boot}"
yes | pacman -S grub efibootmgr
mkdir /esp
mount ${partition_boot} /esp
grub-install --target=x86_64-efi --efi-directory=esp --bootloader-id=GRUB
grub-mkconfig -o /boot/grub/grub.cfg
umount /esp
rm -rf /esp

umount /windows
rm -rf /windows

pacman -S xorg xorg-server
pacman -S gnome
systemctl enable gdm.service
yes | pacman -S gnome-tweaks
pacman -S linux nvidia cuda
